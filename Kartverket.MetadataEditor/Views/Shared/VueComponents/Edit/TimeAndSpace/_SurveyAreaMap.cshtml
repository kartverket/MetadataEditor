@using Resources
@using Kartverket.MetadataEditor.Helpers
@model Kartverket.MetadataEditor.Models.MetadataViewModel

<script type="text/x-template" id="survey-area-map-template">
    <div class="panel panel-default">
        <div class="panel-heading">
            <div class="row">
                <div class="col-md-12">Fullstendighetsdekningskart</div>
                <div class="clearfix"></div>
            </div>
        </div>
        <div class="panel-body">
            <div class="form-group has-feedback">
                <!-- Existing JSON URL -->
                <div class="form-group has-feedback">
                    <div class="row">
                        <label class="col-md-2 control-label">{{ url.fields.jsonUrl.label }}</label>
                        <div class="col-md-10">
                            <input v-bind:type="url.type" v-model="url.value" class="form-control" />
                        </div>
                    </div>
                </div>

                <!-- WMS service URL + load -->
                <div class="form-group has-feedback">
                    <div class="row">
                        <label class="col-md-2 control-label">WMS service URL</label>
                        <div class="col-md-10">
                            <div class="input-group">
                                <input type="text"
                                       v-model="wms.serviceUrl"
                                       class="form-control"
                                       placeholder=""
                                       v-on:input="wms.errorMessage = ''"
                                       v-on:keydown.enter.prevent
                                       v-bind:disabled="wms.loading" />
                                <span class="input-group-btn">
                                    <button type="button"
                                            class="btn"
                                            v-on:click.prevent="loadWmsLayers"
                                            v-bind:disabled="wms.loading">
                                        <span v-if="wms.loading">Laster...</span>
                                        <span v-else>Last lag</span>
                                    </button>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- WMS layer selector -->
                <div class="form-group has-feedback" v-if="wms.layers.length">
                    <div class="row">
                        <label class="col-md-2 control-label">Lag</label>
                        <div class="col-md-10">
                            <div class="custom-select">
                                <select class="form-control"
                                        v-model="wms.selectedLayer"
                                        v-bind:disabled="wms.loading">
                                    <option v-for="layer in wms.layers"
                                            v-bind:key="layer.name"
                                            v-bind:value="layer.name">
                                        {{ layer.title || layer.name }}
                                    </option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- WMS errors -->
                <div class="row" v-if="wms.errorMessage">
                    <div class="col-md-10 col-md-offset-2">
                        <div class="alert alert-danger" role="alert">
                            {{ wms.errorMessage }}
                        </div>
                    </div>
                </div>

            </div>

            <!-- Persist JSON url (existing pattern) -->
            <input v-bind:name="computedSurveyAreaMapUrl.name"
                   type="hidden"
                   v-model="computedSurveyAreaMapUrl.value"
                   class="form-control" />

            <!-- Persist WMS value into $root.model.SurveyAreaMapUrlWms -->
            <input name="SurveyAreaMapUrlWms"
                   type="hidden"
                   v-model="computedSurveyAreaMapUrlWms"
                   class="form-control" />
        </div>
    </div>
</script>

<script>
    var Surveyareamap = {
        name: "surveyareamap",
        template: "#survey-area-map-template",
        data() {
            return {
                url: {
                    value: this.$root.model.SurveyAreaMapUrl,
                    type: 'text',
                    fields: { jsonUrl: { label: 'Json-url' } }
                },
                wms: {
                    serviceUrl: '',
                    selectedLayer: '',
                    layers: [],
                    errorMessage: '',
                    loading: false
                }
            }
        },
        computed: {
            computedSurveyAreaMapUrl: function () {
                return {
                    name: 'SurveyAreaMapUrl',
                    value: this.url.value,
                    label: 'Fullstendighetsdekningskart json-url',
                    type: 'text'
                };
            },
            // Two-way bind to $root.model.SurveyAreaMapUrlWms
            computedSurveyAreaMapUrlWms: {
                get: function () {
                    return this.$root.model.SurveyAreaMapUrlWms || '';
                },
                set: function (val) {
                    this.$root.model.SurveyAreaMapUrlWms = val || '';
                }
            }
        },
        methods: {
            async checkUrlExists(url) {
                try {
                    const head = await fetch(url, { method: 'HEAD', mode: 'cors' });
                    if (head.ok) return true;
                    const get = await fetch(url, { method: 'GET', mode: 'cors' });
                    return get.ok;
                } catch (e) {
                    console.warn('URL check failed', e);
                    return false;
                }
            },
            async ensureDefaultUrl() {
                var datasetId = this.$root.model.ResourceReferenceCode;
                if (datasetId && this.$root.model.SurveyAreaMapUrl && this.$root.model.SurveyAreaMapUrl.trim() !== '') return;
                const defaultUrl = 'https://@(Html.EnvironmentName() == "dev" ? "test" : Html.EnvironmentName())nedlasting.geonorge.no/geonorge/Basisdata/DOKFullstendighetsdekningskart/Kartkatalogen/dekning_' + datasetId + '.geojson';
                if (await this.checkUrlExists(defaultUrl)) {
                    const el = document.getElementById('warning-info');
                    if (el) {
                        el.innerText = 'Fullstendighetsdekningskart url funnet under tid og rom, vennligst lagre for \u00E5 beholde url : ' + defaultUrl;
                        el.classList.remove('hidden');       // remove Bootstrap/utility hidden class if present
                        el.style.display = 'block';          // ensure visible
                    }
                    this.url.value = defaultUrl;
                }
            },
            normalizeGetCapabilities(raw) {
                if (!raw) return '';
                var url = raw.trim();
                url = url.replace(/([?&])request=[^&]*/ig, '')
                         .replace(/([?&])service=[^&]*/ig, '')
                         .replace(/[?&]+$/g, '');
                var sep = url.indexOf('?') >= 0 ? '&' : '?';
                return url + sep + 'service=WMS&request=GetCapabilities';
            },
            async loadWmsLayers() {
                this.wms.errorMessage = '';
                var gcUrl = this.normalizeGetCapabilities(this.wms.serviceUrl);
                if (!gcUrl) {
                    this.wms.errorMessage = 'Oppgi en gyldig WMS-tjeneste-URL.';
                    return;
                }

                this.wms.loading = true;
                try {
                    const res = await fetch('/Wms/GetLayers?serviceUrl=' + encodeURIComponent(gcUrl), {
                        method: 'GET',
                        credentials: 'same-origin'
                    });
                    if (!res.ok) {
                        this.wms.errorMessage = 'Kunne ikke hente WMS-lag (HTTP ' + res.status + ').';
                        throw new Error('Feilet hente WMS-lag');
                    }

                    const data = await res.json();
                    this.wms.layers = Array.isArray(data.layers) ? data.layers : [];

                    if (!this.wms.layers.length) {
                        this.wms.errorMessage = 'Ingen WMS-lag funnet i GetCapabilities.';
                        throw new Error('Ingen WMS-lag funnet');
                    }

                    if (!this.wms.selectedLayer) {
                        this.wms.selectedLayer = this.wms.layers[0].name;
                    }
                } catch (e) {
                    console.warn('Lasting WMS-lag feilet', e);
                    if (!this.wms.errorMessage) {
                        this.wms.errorMessage = 'Lasting av WMS-lag feilet. Kontroller URL og pr√∏v igjen.';
                    }
                    this.wms.layers = [];
                    this.wms.selectedLayer = '';
                } finally {
                    this.wms.loading = false;
                }
            },
            formatWmsValue() {
                var url = (this.wms.serviceUrl || '').trim();
                var layer = (this.wms.selectedLayer || '').trim();
                return (url && layer) ? ('TYPE:WMS@@PATH:' + url + '@@LAYER:' + layer) : (url || '');
            },
            syncWmsToModel() {
                this.computedSurveyAreaMapUrlWms = this.formatWmsValue();
            },
            parseExistingWms(value) {
                if (!value) return;
                var m = /TYPE:WMS@@PATH:(.*?)@@LAYER:(.*)/.exec(value);
                if (m && m.length === 3) {
                    this.wms.serviceUrl = m[1];
                    this.wms.selectedLayer = m[2];
                } else {
                    this.wms.serviceUrl = value;
                }
            }
        },
        watch: {
            'wms.serviceUrl': function () { this.syncWmsToModel(); },
            'wms.selectedLayer': function () { this.syncWmsToModel(); }
        },
        mounted() {
            this.ensureDefaultUrl();
            this.parseExistingWms(this.$root.model.SurveyAreaMapUrlWms);
            this.syncWmsToModel();
            if (this.wms.serviceUrl) this.loadWmsLayers();
        }
    };
</script>